name: Deploy with Git Affirm

on:
  # This workflow should be used for deployment triggers
  push:
    branches: [main]  # Deploy on push to main
  workflow_dispatch:  # Manual trigger
  pull_request:
    types: [closed]
    branches: [main]  # Deploy when PR is merged to main

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest
    # Only run on merged PRs or direct push to main or manual trigger
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # This is the critical step that implements the requirement
      - name: Git Affirm - Check for Positive Emoji PRs
        id: git-affirm
        uses: redhatsam09/git-affirm@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          days-to-check: 7
          second-chance: true
      
      - name: Display Result
        run: echo "${{ steps.git-affirm.outputs.message }}"
      
      # Only proceed with deployment if check passes
      - name: Deploy
        if: steps.git-affirm.outputs.can-deploy == 'true'
        run: |
          echo "Starting deployment process..."
          echo "Deployment successful! 🚀"
          # Add your actual deployment steps here
          
      - name: Deployment Skipped
        if: steps.git-affirm.outputs.can-deploy != 'true'
        run: |
          echo "Deployment was blocked! Your team needs to merge a PR with a positive emoji in the title."
          echo "Try adding emojis like 😊 👍 🎉 ❤️ ✨ to your PR titles!"
          exit 1
